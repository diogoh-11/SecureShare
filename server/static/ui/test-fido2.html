<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SShare API Test Interface</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            background: #f5f5f5;
            border-bottom: 2px solid #ddd;
            overflow-x: auto;
        }

        .tab {
            padding: 15px 25px;
            cursor: pointer;
            border: none;
            background: transparent;
            font-size: 1em;
            font-weight: 600;
            color: #666;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .tab:hover {
            background: #e0e0e0;
        }

        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 600;
        }

        input, textarea, select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
            font-family: 'Courier New', monospace;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .response {
            margin-top: 15px;
            padding: 15px;
            background: #fff;
            border-radius: 6px;
            border: 2px solid #ddd;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 400px;
            overflow-y: auto;
        }

        .response.success {
            border-color: #4caf50;
            background: #f1f8f4;
        }

        .response.error {
            border-color: #f44336;
            background: #fef1f0;
            color: #c62828;
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        .info-box p {
            margin: 5px 0;
            color: #1565c0;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-indicator.active {
            background: #4caf50;
        }

        .status-indicator.inactive {
            background: #f44336;
        }

        .session-info {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
        }

        .session-info h4 {
            margin-bottom: 10px;
            color: #333;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        code {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>
    <div class="session-info" id="sessionInfo">
        <h4>Session Status</h4>
        <p>
            <span class="status-indicator inactive" id="statusIndicator"></span>
            <span id="sessionStatus">Not logged in</span>
        </p>
        <p><small id="sessionUser"></small></p>
    </div>

    <div class="container">
        <header>
            <h1>SShare API Test Interface</h1>
            <p>Test User Creation, FIDO2 Activation & Authentication</p>
        </header>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('users')">User Management</button>
            <button class="tab" onclick="switchTab('activation')">User Activation</button>
            <button class="tab" onclick="switchTab('authentication')">Authentication</button>
            <button class="tab" onclick="switchTab('session')">Session</button>
        </div>

        <!-- User Management Tab -->
        <div id="users" class="tab-content active">
            <div class="info-box">
                <p><strong>User Management Operations</strong></p>
                <p>Create, view, and delete users. Note: User creation generates an activation code.</p>
            </div>

            <div class="section">
                <h3>Create User</h3>
                <div class="form-group">
                    <label for="createUsername">Username</label>
                    <input type="text" id="createUsername" placeholder="Enter username">
                </div>
                <button onclick="createUser()">Create User</button>
                <div id="createUserResponse" class="response" style="display:none;"></div>
            </div>

            <div class="section">
                <h3>Get All Users</h3>
                <button onclick="getAllUsers()">Fetch Users</button>
                <div id="getUsersResponse" class="response" style="display:none;"></div>
            </div>

            <div class="section">
                <h3>Delete User</h3>
                <div class="form-group">
                    <label for="deleteUserId">User ID</label>
                    <input type="number" id="deleteUserId" placeholder="Enter user ID">
                </div>
                <button onclick="deleteUser()" class="btn-danger">Delete User</button>
                <div id="deleteUserResponse" class="response" style="display:none;"></div>
            </div>

            <div class="section">
                <h3>Get User Public Key</h3>
                <div class="form-group">
                    <label for="getUserKeyId">User ID</label>
                    <input type="number" id="getUserKeyId" placeholder="Enter user ID">
                </div>
                <button onclick="getUserPublicKey()">Get Public Key</button>
                <div id="getUserKeyResponse" class="response" style="display:none;"></div>
            </div>
        </div>

        <!-- User Activation Tab -->
        <div id="activation" class="tab-content">
            <div class="info-box">
                <p><strong>FIDO2 User Activation Flow</strong></p>
                <p>1. Get registration challenge</p>
                <p>2. Register FIDO2 credential with authenticator</p>
                <p>3. Submit credential to activate account</p>
            </div>

            <div class="section">
                <h3>Step 1: Get Registration Challenge</h3>
                <div class="form-group">
                    <label for="regUsername">Username</label>
                    <input type="text" id="regUsername" placeholder="Enter username to activate">
                </div>
                <div class="form-group">
                    <label for="activationCode">Activation Code</label>
                    <input type="text" id="activationCode" placeholder="Enter activation code from user creation">
                </div>
                <button onclick="getRegistrationChallenge()">Get Challenge</button>
                <div id="regChallengeResponse" class="response" style="display:none;"></div>
            </div>

            <div class="section">
                <h3>Step 2: Register FIDO2 Credential</h3>
                <p><small>This will trigger your authenticator (e.g., security key, fingerprint, face recognition)</small></p>
                <button onclick="registerFIDO2Credential()">Register with Authenticator</button>
                <div id="regCredentialResponse" class="response" style="display:none;"></div>
            </div>

            <div class="section">
                <h3>Step 3: Activate Account</h3>
                <div class="form-group">
                    <label for="activatePublicKey">Encryption Public Key (base64)</label>
                    <textarea id="activatePublicKey" placeholder="Your RSA/ECC public key in base64"></textarea>
                </div>
                <div class="form-group">
                    <label for="activatePrivateKeyBlob">Private Key Blob (base64, encrypted)</label>
                    <textarea id="activatePrivateKeyBlob" placeholder="Your password-encrypted private key blob in base64"></textarea>
                </div>
                <button onclick="activateAccount()">Activate Account</button>
                <div id="activateResponse" class="response" style="display:none;"></div>
            </div>
        </div>

        <!-- Authentication Tab -->
        <div id="authentication" class="tab-content">
            <div class="info-box">
                <p><strong>FIDO2 Authentication Flow</strong></p>
                <p>1. Get authentication challenge</p>
                <p>2. Sign challenge with FIDO2 credential</p>
                <p>3. Verify and create session</p>
            </div>

            <div class="section">
                <h3>Step 1: Get Authentication Challenge</h3>
                <div class="form-group">
                    <label for="loginUsername">Username</label>
                    <input type="text" id="loginUsername" placeholder="Enter username">
                </div>
                <button onclick="getAuthChallenge()">Get Challenge</button>
                <div id="authChallengeResponse" class="response" style="display:none;"></div>
            </div>

            <div class="section">
                <h3>Step 2: Authenticate with FIDO2</h3>
                <p><small>This will trigger your authenticator to sign the challenge</small></p>
                <button onclick="authenticateFIDO2()">Authenticate</button>
                <div id="authResponse" class="response" style="display:none;"></div>
            </div>

            <div class="section">
                <h3>Step 3: Verify Login</h3>
                <button onclick="verifyLogin()">Verify & Create Session</button>
                <div id="loginResponse" class="response" style="display:none;"></div>
            </div>
        </div>

        <!-- Session Tab -->
        <div id="session" class="tab-content">
            <div class="info-box">
                <p><strong>Session Management</strong></p>
                <p>View current session and logout functionality</p>
            </div>

            <div class="section">
                <h3>Current Session</h3>
                <div class="form-group">
                    <label for="currentToken">Session Token</label>
                    <input type="text" id="currentToken" readonly placeholder="Login to see session token">
                </div>
                <div class="btn-group">
                    <button onclick="copyToken()">Copy Token</button>
                    <button onclick="logout()" class="btn-danger">Logout</button>
                </div>
                <div id="logoutResponse" class="response" style="display:none;"></div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let state = {
            registrationChallenge: null,
            registrationChallengeId: null,
            registrationCredential: null,
            authChallenge: null,
            authChallengeId: null,
            authCredential: null,
            sessionToken: null,
            currentUsername: null
        };

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // Helper functions
        function showResponse(elementId, data, isError = false) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.className = 'response ' + (isError ? 'error' : 'success');
            element.textContent = JSON.stringify(data, null, 2);
        }

        function updateSessionInfo() {
            const statusIndicator = document.getElementById('statusIndicator');
            const sessionStatus = document.getElementById('sessionStatus');
            const sessionUser = document.getElementById('sessionUser');
            const currentToken = document.getElementById('currentToken');

            if (state.sessionToken) {
                statusIndicator.className = 'status-indicator active';
                sessionStatus.textContent = 'Logged in';
                sessionUser.textContent = `User: ${state.currentUsername || 'Unknown'}`;
                currentToken.value = state.sessionToken;
            } else {
                statusIndicator.className = 'status-indicator inactive';
                sessionStatus.textContent = 'Not logged in';
                sessionUser.textContent = '';
                currentToken.value = '';
            }
        }

        function arrayBufferToBase64(buffer) {
            const bytes = new Uint8Array(buffer);
            let binary = '';
            for (let i = 0; i < bytes.byteLength; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            // Use btoa with proper error handling for binary data
            try {
                return btoa(binary);
            } catch (e) {
                // Fallback to manual base64 encoding for binary data
                const base64chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/';
                let result = '';
                const len = bytes.length;
                for (let i = 0; i < len; i += 3) {
                    const a = bytes[i];
                    const b = i + 1 < len ? bytes[i + 1] : 0;
                    const c = i + 2 < len ? bytes[i + 2] : 0;

                    const bitmap = (a << 16) | (b << 8) | c;

                    result += base64chars[(bitmap >> 18) & 63];
                    result += base64chars[(bitmap >> 12) & 63];
                    result += i + 1 < len ? base64chars[(bitmap >> 6) & 63] : '=';
                    result += i + 2 < len ? base64chars[bitmap & 63] : '=';
                }
                return result;
            }
        }

        function base64ToArrayBuffer(base64) {
            // Convert URL-safe base64 to standard base64
            let standardBase64 = base64.replace(/-/g, '+').replace(/_/g, '/');

            // Add padding if needed
            while (standardBase64.length % 4) {
                standardBase64 += '=';
            }

            const binary = atob(standardBase64);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) {
                bytes[i] = binary.charCodeAt(i);
            }
            return bytes.buffer;
        }

        // User Management
        async function createUser() {
            const username = document.getElementById('createUsername').value;

            try {
                const response = await fetch('/api/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username })
                });

                const data = await response.json();
                showResponse('createUserResponse', data, !response.ok);
            } catch (error) {
                showResponse('createUserResponse', { error: error.message }, true);
            }
        }

        async function getAllUsers() {
            try {
                const response = await fetch('/api/users');
                const data = await response.json();
                showResponse('getUsersResponse', data, !response.ok);
            } catch (error) {
                showResponse('getUsersResponse', { error: error.message }, true);
            }
        }

        async function deleteUser() {
            const userId = document.getElementById('deleteUserId').value;

            try {
                const response = await fetch(`/api/users/${userId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                showResponse('deleteUserResponse', data, !response.ok);
            } catch (error) {
                showResponse('deleteUserResponse', { error: error.message }, true);
            }
        }

        async function getUserPublicKey() {
            const userId = document.getElementById('getUserKeyId').value;

            try {
                const response = await fetch(`/api/users/${userId}/key`);
                const data = await response.json();
                showResponse('getUserKeyResponse', data, !response.ok);
            } catch (error) {
                showResponse('getUserKeyResponse', { error: error.message }, true);
            }
        }

        // FIDO2 Registration
        async function getRegistrationChallenge() {
            const username = document.getElementById('regUsername').value;
            const activationCode = document.getElementById('activationCode').value;

            try {
                const response = await fetch(`/api/auth/activate/challenge?username=${encodeURIComponent(username)}&activation_code=${encodeURIComponent(activationCode)}`);
                const data = await response.json();

                if (response.ok) {
                    state.registrationChallenge = data.options.publicKey;
                    state.registrationChallengeId = data.challenge_id;
                    showResponse('regChallengeResponse', data, false);
                } else {
                    showResponse('regChallengeResponse', data, true);
                }
            } catch (error) {
                showResponse('regChallengeResponse', { error: error.message }, true);
            }
        }

        async function registerFIDO2Credential() {
            if (!state.registrationChallenge) {
                showResponse('regCredentialResponse', { error: 'Get registration challenge first' }, true);
                return;
            }

            try {
                // Convert base64 strings to ArrayBuffers
                const options = state.registrationChallenge;
                const publicKeyCredentialCreationOptions = {
                    challenge: base64ToArrayBuffer(options.challenge),
                    rp: options.rp,
                    user: {
                        id: base64ToArrayBuffer(options.user.id),
                        name: options.user.name,
                        displayName: options.user.displayName
                    },
                    pubKeyCredParams: options.pubKeyCredParams,
                    timeout: options.timeout || 60000,
                    attestation: options.attestation || 'none',
                    authenticatorSelection: options.authenticatorSelection || {}
                };

                const credential = await navigator.credentials.create({
                    publicKey: publicKeyCredentialCreationOptions
                });

                // Store credential data
                state.registrationCredential = {
                    id: credential.id,
                    rawId: arrayBufferToBase64(credential.rawId),
                    response: {
                        clientDataJSON: arrayBufferToBase64(credential.response.clientDataJSON),
                        attestationObject: arrayBufferToBase64(credential.response.attestationObject)
                    },
                    type: credential.type
                };

                showResponse('regCredentialResponse', {
                    success: true,
                    message: 'FIDO2 credential registered successfully',
                    credentialId: credential.id
                }, false);
            } catch (error) {
                showResponse('regCredentialResponse', { error: error.message }, true);
            }
        }

        async function activateAccount() {
            const username = document.getElementById('regUsername').value;
            const publicKey = document.getElementById('activatePublicKey').value;
            const privateKeyBlob = document.getElementById('activatePrivateKeyBlob').value;

            if (!state.registrationCredential) {
                showResponse('activateResponse', { error: 'Register FIDO2 credential first' }, true);
                return;
            }

            const activationCode = document.getElementById('activationCode').value;

            try {
                const response = await fetch('/api/auth/activate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: username,
                        activation_code: activationCode,
                        challenge_id: state.registrationChallengeId,
                        credential_data: state.registrationCredential,
                        public_key: publicKey,
                        private_key_blob: privateKeyBlob
                    })
                });

                const data = await response.json();
                showResponse('activateResponse', data, !response.ok);

                if (response.ok) {
                    // Reset registration state
                    state.registrationChallenge = null;
                    state.registrationChallengeId = null;
                    state.registrationCredential = null;
                }
            } catch (error) {
                showResponse('activateResponse', { error: error.message }, true);
            }
        }

        // FIDO2 Authentication
        async function getAuthChallenge() {
            const username = document.getElementById('loginUsername').value;

            try {
                const response = await fetch(`/api/auth/login/challenge?username=${encodeURIComponent(username)}`);
                const data = await response.json();

                if (response.ok) {
                    state.authChallenge = data.options.publicKey;
                    state.authChallengeId = data.challenge_id;
                    state.allowCredentials = data.allowCredentials;
                    state.currentUsername = username;
                    showResponse('authChallengeResponse', data, false);
                } else {
                    showResponse('authChallengeResponse', data, true);
                }
            } catch (error) {
                showResponse('authChallengeResponse', { error: error.message }, true);
            }
        }

        async function authenticateFIDO2() {
            if (!state.authChallenge) {
                showResponse('authResponse', { error: 'Get authentication challenge first' }, true);
                return;
            }

            try {
                // Convert base64 strings to ArrayBuffers
                const options = state.authChallenge;
                const allowCredentials = state.allowCredentials.map(cred => ({
                    type: cred.type,
                    id: base64ToArrayBuffer(cred.id)
                }));

                const publicKeyCredentialRequestOptions = {
                    challenge: base64ToArrayBuffer(options.challenge),
                    timeout: options.timeout || 60000,
                    rpId: options.rpId,
                    allowCredentials: allowCredentials,
                    userVerification: options.userVerification || 'preferred'
                };

                const assertion = await navigator.credentials.get({
                    publicKey: publicKeyCredentialRequestOptions
                });

                // Store assertion data
                state.authCredential = {
                    id: assertion.id,
                    rawId: arrayBufferToBase64(assertion.rawId),
                    response: {
                        clientDataJSON: arrayBufferToBase64(assertion.response.clientDataJSON),
                        authenticatorData: arrayBufferToBase64(assertion.response.authenticatorData),
                        signature: arrayBufferToBase64(assertion.response.signature),
                        userHandle: assertion.response.userHandle ? arrayBufferToBase64(assertion.response.userHandle) : null
                    },
                    type: assertion.type
                };

                showResponse('authResponse', {
                    success: true,
                    message: 'FIDO2 authentication successful',
                    credentialId: assertion.id
                }, false);
            } catch (error) {
                showResponse('authResponse', { error: error.message }, true);
            }
        }

        async function verifyLogin() {
            const username = document.getElementById('loginUsername').value;

            if (!state.authCredential) {
                showResponse('loginResponse', { error: 'Authenticate with FIDO2 first' }, true);
                return;
            }

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: username,
                        challenge_id: state.authChallengeId,
                        credential_id: arrayBufferToBase64(state.authCredential.rawId),
                        credential_data: {
                            clientDataJSON: arrayBufferToBase64(state.authCredential.response.clientDataJSON),
                            authenticatorData: arrayBufferToBase64(state.authCredential.response.authenticatorData),
                            signature: arrayBufferToBase64(state.authCredential.response.signature)
                        }
                    })
                });

                const data = await response.json();
                showResponse('loginResponse', data, !response.ok);

                if (response.ok) {
                    state.sessionToken = data.session_token;
                    state.currentUsername = data.username;
                    updateSessionInfo();

                    // Reset auth state
                    state.authChallenge = null;
                    state.authChallengeId = null;
                    state.authCredential = null;
                }
            } catch (error) {
                showResponse('loginResponse', { error: error.message }, true);
            }
        }

        // Session Management
        function copyToken() {
            const tokenInput = document.getElementById('currentToken');
            tokenInput.select();
            document.execCommand('copy');
            alert('Token copied to clipboard');
        }

        async function logout() {
            if (!state.sessionToken) {
                showResponse('logoutResponse', { error: 'Not logged in' }, true);
                return;
            }

            try {
                const response = await fetch('/api/auth/logout', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${state.sessionToken}`
                    }
                });

                const data = await response.json();
                showResponse('logoutResponse', data, !response.ok);

                if (response.ok) {
                    state.sessionToken = null;
                    state.currentUsername = null;
                    updateSessionInfo();
                }
            } catch (error) {
                showResponse('logoutResponse', { error: error.message }, true);
            }
        }

        // Initialize
        updateSessionInfo();
    </script>
</body>
</html>
