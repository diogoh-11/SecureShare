<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SShare - Login</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background-color: #000;
            color: #fff;
            font-family: monospace;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 600px;
            width: 100%;
            border: 2px solid #fff;
            padding: 40px;
        }
        h1 {
            font-size: 48px;
            text-align: center;
            margin-bottom: 40px;
            letter-spacing: 8px;
        }
        .status {
            padding: 20px;
            border: 1px solid #fff;
            margin-bottom: 20px;
            min-height: 100px;
        }
        button {
            background-color: #fff;
            color: #000;
            border: none;
            padding: 15px 30px;
            font-family: monospace;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
        }
        button:hover { background-color: #ccc; }
        button:disabled {
            background-color: #444;
            color: #888;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>SSHARE</h1>
        <div class="status" id="status">Ready to login...</div>
        <button id="loginBtn" onclick="startLogin()">START LOGIN</button>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const username = urlParams.get('username');
        const callbackUrl = urlParams.get('callback');
        const API_BASE = window.location.origin + '/api/auth';

        if (!username) {
            document.getElementById('status').textContent = 'ERROR: Missing username in URL';
            document.getElementById('loginBtn').disabled = true;
        }

        if (!callbackUrl) {
            document.getElementById('status').textContent = 'ERROR: Missing callback URL. Please start from TUI.';
            document.getElementById('loginBtn').disabled = true;
        }

        function arrayBufferToBase64(buffer) {
            const bytes = new Uint8Array(buffer);
            let binary = '';
            for (let i = 0; i < bytes.byteLength; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return btoa(binary);
        }

        function base64ToArrayBuffer(base64) {
            if (!base64) throw new Error('Invalid base64 input');
            if (base64 instanceof ArrayBuffer) return base64;
            const base64String = String(base64).replace(/-/g, '+').replace(/_/g, '/');
            const binaryString = atob(base64String);
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        async function startLogin() {
            const btn = document.getElementById('loginBtn');
            const status = document.getElementById('status');

            try {
                btn.disabled = true;
                status.textContent = 'Fetching authentication challenge...';

                const challengeResponse = await fetch(
                    `${API_BASE}/login/challenge?username=${encodeURIComponent(username)}`
                );

                if (!challengeResponse.ok) {
                    const error = await challengeResponse.json();
                    throw new Error(error.detail || 'Failed to get challenge');
                }

                const optionsData = await challengeResponse.json();
                const options = typeof optionsData === 'string' ? JSON.parse(optionsData) : optionsData;

                if (options.challenge) options.challenge = base64ToArrayBuffer(options.challenge);
                if (options.allowCredentials && options.allowCredentials.length > 0) {
                    options.allowCredentials = options.allowCredentials.map(cred => ({
                        ...cred,
                        id: base64ToArrayBuffer(cred.id)
                    }));
                }

                status.textContent = 'Please use your authenticator (fingerprint, security key, phone)...';

                const credential = await navigator.credentials.get({ publicKey: options });
                if (!credential) throw new Error('Authentication failed');

                status.textContent = 'Completing login...';

                const credentialJSON = {
                    username: username,
                    id: credential.id,
                    rawId: arrayBufferToBase64(credential.rawId),
                    response: {
                        clientDataJSON: arrayBufferToBase64(credential.response.clientDataJSON),
                        authenticatorData: arrayBufferToBase64(credential.response.authenticatorData),
                        signature: arrayBufferToBase64(credential.response.signature),
                        userHandle: credential.response.userHandle ? arrayBufferToBase64(credential.response.userHandle) : null
                    },
                    type: credential.type
                };

                const loginResponse = await fetch(`${API_BASE}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(credentialJSON),
                    credentials: 'include'
                });

                if (!loginResponse.ok) {
                    const error = await loginResponse.json();
                    throw new Error(error.detail || 'Login failed');
                }

                const result = await loginResponse.json();
                status.textContent = 'SUCCESS! Redirecting...';
                
                // Redirect to callback with token (using dynamic callback URL)
                window.location.href = `${callbackUrl}?token=${encodeURIComponent(result.session_token)}`;

            } catch (error) {
                status.textContent = 'ERROR: ' + error.message;
                btn.disabled = false;
            }
        }

        if (!window.PublicKeyCredential) {
            document.getElementById('status').textContent = 'ERROR: WebAuthn not supported in this browser';
            document.getElementById('loginBtn').disabled = true;
        }
    </script>
</body>
</html>
